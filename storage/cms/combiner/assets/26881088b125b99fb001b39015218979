
  var gmarkers = [];
  // var gicons = [];
  var map = null;
  var webserviceurl = 'http://localhost/webservices/storelocator.asmx';
  var infowindow = new google.maps.InfoWindow({
    size: new google.maps.Size(150,50)
  });

function initialize() {
    $("p.no-store-result").hide();
    var myOptions = {
      zoom: 13,
      center: new google.maps.LatLng(-37.82263, 144.9322423,17),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    map = new google.maps.Map(document.getElementById("map"), myOptions);
    google.maps.event.addListener(map, 'click', function() {
      infowindow.close();
    });

    //statewise selection
     $( ".state-control a" ).on( "click", function() {
      var state = $(this).data("state");
      var url = webserviceurl + "/GetAllStoresLatLong";
      searchStateLocations(url,state);
      return;
    });

    //form submission
    $("form#map-form").on("submit",function(e){
      e.preventDefault();
    // var formData = new FormData($(this)[0]);
    var params = $(this).serialize();
    var url = webserviceurl+"/SearchForDivisionStoresByPostcodeLatLong"
    searchLocations(url,params);
    return;
    }); 
}

function searchLocations(url, params) {
   clearLocations();
    // var radius = document.getElementById('radiusSelect').value;
    // var searchUrl = 'phpsqlsearch_genxml.php?lat=' + center.lat() + '&lng=' + center.lng() + '&radius=' + radius;
      var searchUrl = url   
      downloadUrl(searchUrl,params,function(data) {
      var xml = data.responseXML;
      var markerNodes = xml.getElementsByTagName("StoreLatLong");
      var bounds = new google.maps.LatLngBounds();

      for (var i = 0; i < markerNodes.length; i++) {
        
          var name = xml.getElementsByTagName("Name")[i].childNodes[0].nodeValue;
          var address1 = xml.getElementsByTagName("Address1")[i].childNodes[0].nodeValue;
          //var address2 = xml.getElementsByTagName("Address2")[i].childNodes[0].nodeValue;
          //var distance = parseFloat(markerNodes[i].getAttribute("distance"));
          var postcode = xml.getElementsByTagName("Postcode")[i].childNodes[0].nodeValue;
          var phone = xml.getElementsByTagName("Phone")[i].childNodes[0].nodeValue;
          var latlng = new google.maps.LatLng(
          parseFloat(xml.getElementsByTagName("Latitude")[i].childNodes[0].nodeValue),
          parseFloat(xml.getElementsByTagName("Longitude")[i].childNodes[0].nodeValue)
          );
        var html = "" + name + "<br/>" + address1 + "<br/>" + postcode + "<br/><p>Phone:" + phone +"</p>";
        //createOption(name, distance, i);

        createMarker(latlng, name, html,postcode);
        bounds.extend(latlng);  

      }
      map.fitBounds(bounds);
      // 
      // locationSelect.style.visibility = "visible";

      // locationSelect.onchange = function() {
      //   var markerNum = locationSelect.options[locationSelect.selectedIndex].value;
      //   google.maps.event.trigger(markers[markerNum], 'click');
      // };
    });
  }

  function searchStateLocations(url, state) {
   clearLocations();

    // var radius = document.getElementById('radiusSelect').value;
    // var searchUrl = 'phpsqlsearch_genxml.php?lat=' + center.lat() + '&lng=' + center.lng() + '&radius=' + radius;
      var searchUrl = url   
      downloadUrl(searchUrl,false,function(data) {
      var xml = data.responseXML;
      var markerNodes = xml.getElementsByTagName("StoreLatLong");
      var bounds = new google.maps.LatLngBounds();
      for (var i = 0; i < markerNodes.length; i++) {
        if(state){
          if (state.toLowerCase() == xml.getElementsByTagName("State")[i].childNodes[0].nodeValue.toLowerCase()){
            var name = xml.getElementsByTagName("Name")[i].childNodes[0].nodeValue;
            var address1 = xml.getElementsByTagName("Address1")[i].childNodes[0].nodeValue;
            //var address2 = xml.getElementsByTagName("Address2")[i].childNodes[0].nodeValue;
            //var distance = parseFloat(markerNodes[i].getAttribute("distance"));
            var postcode = xml.getElementsByTagName("Postcode")[i].childNodes[0].nodeValue;
            var latlng = new google.maps.LatLng(
            parseFloat(xml.getElementsByTagName("Latitude")[i].childNodes[0].nodeValue),
            parseFloat(xml.getElementsByTagName("Longitude")[i].childNodes[0].nodeValue)
            );

            var html = "" + name + " " + address1 + " " + postcode;
            //createOption(name, distance, i);

            createMarker(latlng, name, html,postcode);
            bounds.extend(latlng);   
          } 
        }      
      }
      map.fitBounds(bounds);
      // 
      // locationSelect.style.visibility = "visible";

      // locationSelect.onchange = function() {
      //   var markerNum = locationSelect.options[locationSelect.selectedIndex].value;
      //   google.maps.event.trigger(markers[markerNum], 'click');
      // };
    });
  }
  
   // A function to create the marker and set up the event window
  function createMarker(latlng,name,html,type) {
    var contentString = html;
    var marker = new google.maps.Marker({
      position: latlng,
      map: map,
      title: name,
      // zIndex: Math.round(latlng.lat()*-100000)<<5
    });

    // // === Store the type and name info as a marker properties ===
    marker.mytype = type;
    marker.myname = name;
    gmarkers.push(marker);

    google.maps.event.addListener(marker, 'click', function() {
      infowindow.setContent(contentString);
      infowindow.open(map,marker);
    });
  }

  function downloadUrl(url,params,callback) {  
      var request = window.ActiveXObject ? 
      new ActiveXObject('Microsoft.XMLHTTP') : new XMLHttpRequest;   
      request.onreadystatechange = function() {    
        if (request.readyState == 4) {  
          request.onreadystatechange = doNothing;          
          callback(request);    
        } 
      };   
      request.open('POST', url, true);  
      request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      if(params){
        request.send(params); 
      } else {
        request.send(null); 
      }
      
  }
function clearLocations() {
  for (var i = 0; i < gmarkers.length; i++) {
   gmarkers[i].setMap(null);
  }
  gmarkers.length = 0;
}
  

  function parseXml(str) {
      if (window.ActiveXObject) {
        var doc = new ActiveXObject('Microsoft.XMLDOM');
        doc.loadXML(str);
        return doc;
      } else if (window.DOMParser) {
        return (new DOMParser).parseFromString(str, 'text/xml');
      }
    }

   function doNothing() {} 